
trigger:
  - none

pool:
  vmImage: ubuntu-latest

variables:
  DeviceCount: 2
  MessageCount: 5
  Interval: 10
  ContainerCount: 2
  evhResourceGroup: 'dataops-temperature-events'
  evhNamespace: 'evh-temperature-test'
  evhName: 'temperature-processing'
  serviceConnection: dataops-temperature-events-sn
  keyVaultName: 'kv-temperature-test'

steps:
# Store your eventhub connection string and subscription id in keyvault.
- task: AzureKeyVault@1
  inputs:
    azureSubscription: $(serviceConnection)
    KeyVaultName: $(keyVaultName)
    SecretsFilter: 'LoadTestEventHubConnectionString, SubscriptionId'
    RunAsPreJob: false

- task: AzureCLI@2
  displayName: 'Run IoTSimulator on ACI'
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: pscore
    scriptPath: IoTSimulator.ps1
    arguments: '-EventHubConnectionString $(LoadTestEventHubConnectionString) 
    -DeviceCount $(DeviceCount) -MessageCount $(MessageCount) -Interval $(Interval) 
    -ContainerCount $(ContainerCount)'

- task: AzureCLI@2
  displayName: 'Check Load Test Result'
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: pscore
    scriptPath: LoadTestCheckResult.ps1
    arguments: '-evhSubscriptionId $(SubscriptionId) -evhResourceGroup $(evhResourceGroup) 
    -evhNamespace $(evhNamespace) -evhName $(evhName)'
