parameters:
- name: environmentName
  type: string
- name: serviceConnection
  type: string

jobs:
- deployment: Deploy_Wheel_To_Synapse
  displayName: Deploy Wheel Package to Synapse
  environment: ${{ parameters.environmentName }}
  pool: 
    vmImage: macOS-11
  strategy:
    runOnce:
      deploy:
        steps:
        - script: |
            az --version
            az upgrade --yes
          name: az_upgrade
          displayName: 'upgrade az cli to latest version'

        - script: |
            packageWheelName=$(ls ${WHEEL_FILE_PATH} | grep '^ddo_transform.*.whl$' | head -n 1)
            echo "Package wheel name is: $packageWheelName"
            echo "##vso[task.setvariable variable=packageWheelName;isOutput=true]$packageWheelName"
          env:
            WHEEL_FILE_PATH: $(Pipeline.Workspace)/ciartifacts/dist
          name: setPackageWheelName
          displayName: 'Set packageWheelName variable'

        - task: AzureCLI@2
          displayName: Upload package to Synapse workspace
          inputs:
            azureSubscription: ${{ parameters.serviceConnection }}
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az synapse workspace-package upload \
              --workspace-name $(synapseWorkspaceName) \
              --package $(Pipeline.Workspace)/ciartifacts/dist/$(setPackageWheelName.packageWheelName)
        
        - task: AzureCLI@2
          displayName: Upload package to Synapse workspace
          inputs:
            azureSubscription: ${{ parameters.serviceConnection }}
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az synapse spark pool update \
              --name $(synapseSparkPoolName) \ 
              --workspace-name $(synapseWorkspaceName) \ 
              --resource-group $(rgName) \ 
              --package-action Add \
              --package $(setPackageWheelName.packageWheelName)
