parameters:
- name: devAdfName
  displayName: Name of DEV Azure Data Factory
- name: githubRepoName
  displayName: Github Full Repo Name (<my_github_account>/<repo_name>)

trigger: none

resources:
  pipelines:
  - pipeline: ciartifacts
    source: ci-artifacts
    trigger: 
      branches:
      - master
  repositories:
  - repository: mdwdataops_adfpublish
    type: github
    endpoint: mdwdo-park-github
    name: ${{ parameters.githubRepoName }}
    ref: adf_publish

stages:
- stage: deploy_to_stg
  displayName: 'Deploy to DEV'  # In DEV, excludes publishing to ADF as this is a manual publish step
  variables:
  - group: mdwdo-park-release-dev
  jobs:
  - template: templates/jobs/deploy-databricks-job.yml
    parameters:
      environmentName: 'DEV'
  - template: templates/jobs/deploy-azuresqldb-job.yml
    parameters:
      environmentName: 'DEV'
      serviceConnection: 'mdwdo-park-service-connection-dev'

- stage: deploy_to_stg
  displayName: 'Deploy to Stage'
  variables:
  - group: mdwdo-park-release-stg
  jobs: 
  - template: templates/jobs/deploy-databricks-job.yml
    parameters:
      environmentName: 'STG'
  - template: templates/jobs/deploy-azuresqldb-job.yml
    parameters:
      environmentName: 'STG'
      serviceConnection: 'mdwdo-park-service-connection-stg'
  - template: templates/jobs/deploy-adf-job.yml
    parameters:
      environmentName: 'STG'
      serviceConnection: 'mdwdo-park-service-connection-stg'
      devAdfName: ${{ parameters.devAdfName }}

# - stage: deploy_to_prod
#   displayName: 'Deploy to Prod'
#   variables:
#   - group: mdwdo-park-release-prod
#   jobs: 
#   - template: templates/jobs/deploy-databricks-job.yml
#     parameters:
#       environmentName: 'PROD'
#   - template: templates/jobs/deploy-azuresqldb-job.yml
#     parameters:
#       environmentName: 'PROD'
#       serviceConnection: 'mdwdo-park-service-connection-prod'
#   - template: templates/jobs/deploy-adf-job.yml
#     parameters:
#       environmentName: 'PROD'
#       serviceConnection: 'mdwdo-park-service-connection-prod'